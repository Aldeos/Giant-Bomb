Phoenix.ImageViewer=Phoenix.ImageViewer||{};(function(a){a.Models=a.Models||{};a.Models.Image=Backbone.Model.extend({defaults:{original:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("src")){this.set({src:this.defaults.title})}}});a.Models.Comment=Backbone.Model.extend({defaults:{avatar:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("avatar")){this.set({avatar:this.defaults.title})}}})}(Phoenix.ImageViewer||{}));
(function(a){a.Collections=a.Collections||{};a.Collections.Images=Backbone.Collection.extend({model:a.Models.Image,parse:function(b,c){return b.images},initialize:function(){this.on("add",function(b){if(!b.id){throw new Error("Invalid model data.")}})}});a.Collections.Comments=Backbone.Collection.extend({model:a.Models.Comment})}(Phoenix.ImageViewer||{}));
(function(a){a.Views=a.Views||{};a.Views.Mixins={loadResults:function(d,b){var c=this;b=b||{};if(!this.loadingResults){this.loadingResults=true;this.collection.fetch({url:d.fetchUrl,add:true,data:{images:d.imageIds,start:d.startingIndex+=d.requestThreshold,count:d.requestThreshold,object:d.objectId||""},success:function(f,e){c.loadingResults=false;if(b.success){b.success.call(c,e)}},error:function(e,g,f){c.loadingResults=false},complete:function(){if(b.complete){b.complete.call(c)}}})}}}}(Phoenix.ImageViewer||{}));
(function(a){var b=Phoenix.getDocument();a.Views.Viewer=Backbone.View.extend(_.extend({},a.Views.Mixins,{el:Phoenix.jQuery.getBody(),els:{},collectionIndex:0,viewerOpen:false,viewerMode:"",gutterSize:0,btnSize:120,thumbSize:150,imageIds:"",objectId:"",activeGuid:null,startingIndex:0,requestThreshold:30,windowWidth:null,windowHeight:null,paneWidth:null,paneHeight:null,commentUrl:null,viewerEnabled:true,entryUrl:"",isPhone:false,currentFetch:null,commandsTipCookieKey:"image_commands_tip_hidden",commandsTipFadeOutDelay:4000,commandsTipHideDelay:2000,commandsTipTimeout:null,events:{"click #js-image-close":"closeViewer","click #js-image-prev":"prevImage","click #js-image-next":"nextImage","click #js-image-pane":"nextImage","click #js-image-view-film":"toggleFilmStrip","click #js-image-fs":"toggleFullscreen","click #wrapper figure a":"loadFromEmbed"},initialize:function(){var d=this;this.setEls().setStage();this.entryUrl=window.location.pathname+window.location.search;var c=$('meta[itemprop="deviceType"]').attr("content");if(c==="phone"){this.isPhone=true}this.initializeCollection();if(this.isPhone){return}this.commentPoster=new a.Views.CommentPoster({});Phoenix.jQuery.getWindow().on({resize:$.proxy(this.setStage,this),keyup:$.proxy(this.keypressHandler,this)});this.els.$sideColumn.on("click","a",function(f){d.stopEvent(f);d.closeViewer(f,true);window.location.href=f.target.href})},initializeCollection:function(){var c=this;if(this.currentFetch!==null){this.currentFetch.abort()}var e=Phoenix.jQuery.getWrapper().find("#galleryMarker");this.viewerMode=(e.data("mode"))?e.data("mode"):"adHoc";this.requestThreshold=this.calculateThreshold();var d=$("meta[itemprop=cdnHost]").attr("content");this.fetchUrl="/js/image-data.json";if(this.viewerMode==="gallery"){this.imageIds=e.data("galleryId");this.objectId=e.data("objectId");window.onbeforeunload=function(f){c.closeViewer(f,true)}}else{if(this.viewerMode==="permalink"){this.fetchUrl=d+this.fetchUrl;this.imageIds=e.data("refId");$("#js-image-close").hide()}else{if(this.viewerMode==="adHoc"){this.imageIds=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")}).get().join(",");window.onbeforeunload=function(f){c.closeViewer(f,true)};b.on("image-viewer-rescrape",function(f){var h=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")});var i=c.imageIds.split(",");var g=_.difference(h,i);c.imageIds=g.join(",");c.loadResults(a.App);c.imageIds=_.union(i,g).join(",")});if(this.imageIds.length<300){this.fetchUrl=d+this.fetchUrl}else{this.destroyCollection();this.disableViewer();$("figure a").click(function(f){f.preventDefault();if($(this).attr("href").length>0){window.open($(this).attr("href").replace("square_avatar","original"),"_blank")}return false})}}}}if(this.imageIds===""){return}this.currentFetch=this.collection.fetch({url:this.fetchUrl,data:{images:this.imageIds,start:this.startingIndex,count:this.requestThreshold,object:this.objectId},success:function(){Phoenix.jQuery.getWindow().trigger("collectionLoaded");if(c.collection.length>0){c.commentUrl=c.collection.at(0).get("addCommentUrl")}},error:function(f,h,g){if(h==="timeout"){}}})},destroyCollection:function(){this.startingIndex=0;this.collection.reset()},disableViewer:function(){this.viewerEnabled=false},enableViewer:function(){this.viewerEnabled=true},render:function(d){if(this.isPhone){return}if(!this.viewerOpen){b.trigger("render_page_event",["image_view"])}this.activeGuid=d;var c=this.collection.get(d);this.imageView=new a.Views.ImageView({model:c});this.titleBar=new a.Views.TitleBar({model:c});this.info=new a.Views.InfoBar({model:c});if(this.collection.length>1&&!this.filmstrip){this.filmstrip=new a.Views.Filmstrip({collection:this.collection})}this.togglePaginationVisibility();if(!this.viewerOpen){this.els.$viewer.addClass("filmstripOpen");if(this.shouldShowCommandsTip()){this.toggleCommandsTip("show")}Phoenix.jQuery.getHtml().css("overflow-y","hidden");this.viewerOpen=true}return this},calculateThreshold:function(){if(this.viewerMode==="adHoc"){return -1}if(this.isPhone){return 5}return(Math.floor(this.windowWidth/this.thumbSize)*Math.ceil(this.stripHeight/this.thumbSize))},keypressHandler:function(d){if(!this.viewerOpen){return}var c=Phoenix.Core.keycodes;if(this.$el.data("filmstripOpen")){switch(d.which){case c.rightArrow:this.filmstrip.moveHighlight("right");break;case c.leftArrow:this.filmstrip.moveHighlight("left");break;case c.downArrow:this.filmstrip.moveHighlight("down");break;case c.upArrow:this.filmstrip.moveHighlight("up");break;case c.escapeKey:this.toggleFilmStrip();break;case c.enterKey:this.filmstrip.showImage(d);break}}else{switch(d.which){case c.escapeKey:this.closeViewer();break;case c.rightArrow:this.nextImage();break;case c.leftArrow:this.prevImage();break;case c.upArrow:this.toggleFilmStrip();break}}return this},closeViewer:function(c,d){if(!this.viewerOpen){return}if(this.viewerMode==="permalink"&&!d){return false}b.trigger("remove_page_event",["image_view"]);this.els.$viewer.removeClass("filmstripOpen");if(this.isCommandsTipOpen()!==false){this.toggleCommandsTip("hide")}Phoenix.jQuery.getHtml().css("overflow-y","scroll");this.resetUrl();this.viewerOpen=false;return this},resetUrl:function(){a.Routers.AppRouter.navigate(this.entryUrl);return this},prevImage:function(c){this.stopEvent(c);if(this.collectionIndex===0){return false}this.collectionIndex--;this.setUrlHash();return this},nextImage:function(c){this.stopEvent(c);if(this.collectionIndex>=this.collection.length-3){this.loadMoreImages()}if(this.collectionIndex===this.collection.length-1){return false}this.collectionIndex++;this.setUrlHash();return this},loadMoreImages:function(c){if(this.viewerMode!=="gallery"){return}this.loadResults(a.App,{complete:function(){if(c){c()}}})},setUrlHash:function(d){var c=this.viewerOpen;if(!c){b.trigger("render_page_event",["image_view",true])}else{b.trigger("update_page_event",["image_view"])}d=d||this.collection.at(this.collectionIndex).id;a.Routers.AppRouter.navigate("images/"+d,{trigger:true,replace:c});return this},loadImage:function(c){this.collectionIndex=_.indexOf(this.collection.models,this.collection.get(c));if(this.collectionIndex===-1){Phoenix.Ui.showErrorMessage("Error loading image viewer: invalid model data.");this.resetUrl();throw new Error("Model not set.")}this.render(c);return this},loadFromEmbed:function(c){if(!this.viewerEnabled){return}var d=$(c.currentTarget).data("refId");if(d){this.stopEvent(c).setUrlHash(d)}return this},showFilmStrip:function(){this.els.$viewer.addClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",true);return this},hideFilmStrip:function(){this.els.$viewer.removeClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",false);return this},toggleFilmStrip:function(c){this.stopEvent(c);if(this.$el.data("filmstripOpen")){this.hideFilmStrip()}else{this.showFilmStrip();this.filmstrip.render.call(this.filmstrip,null,this.collectionIndex)}},stopEvent:function(c){if(c){c.preventDefault();c.stopPropagation()}return this},togglePaginationVisibility:function(){if(this.collection.length===1){return false}else{if(this.collectionIndex===0){this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.addClass("hidden")}else{if(this.collectionIndex===this.collection.length-1){this.els.$imageNext.addClass("hidden");this.els.$imagePrev.removeClass("hidden")}else{this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.removeClass("hidden")}}}return this},setEls:function(){var c=this.els,d=c.$viewer=$("#js-filmstrip");c.$imageBtnIcon=d.find("#js-btn-icon");c.$imagePane=d.find("#js-image-pane");c.$sideColumn=d.find("#js-side-column");c.$imagePrev=d.find("#js-image-prev");c.$imageNext=d.find("#js-image-next");c.$imageSource=d.find("#imageSource");c.$filmstripTab=d.find("#js-image-view-film");c.$imageStrip=d.find("#js-image-strip");c.$adLeader=d.find("#js-image-ad-leader");c.$commandsTip=d.find("#js-image-commands-tip");c.$imageClose=d.find("#js-image-close");return this},setStage:function(){var f=this.els;this.windowWidth=Phoenix.jQuery.getWindow().width();this.windowHeight=Phoenix.jQuery.getWindow().height();this.stripHeight=Math.floor(this.windowHeight*0.5*0.95);var e=this.windowHeight-f.$adLeader.height(),d=null,c=[f.$sideColumn];var h=$("#js-image-fs").data("fullscreen");var g=(3*this.gutterSize);this.paneWidth=this.windowWidth-f.$sideColumn.width()-10;this.paneHeight=e;f.$sideColumn.css({top:f.$adLeader.outerHeight()});f.$imagePane.css({width:this.paneWidth,height:this.paneHeight});f.$imageClose.css({top:f.$adLeader.outerHeight()+40,right:f.$sideColumn.width()+40});for(d=0;d<c.length;d++){c[d].height(e)}this.centerFilmstripTab();this.imageStripRowSize=Math.floor(this.windowWidth/this.thumbSize);if(this.imageView){this.imageView.centerImage()}return this},centerFilmstripTab:function(){this.els.$filmstripTab.css({left:(this.paneWidth/2)-(this.btnSize/2)});return this},toggleFullscreen:function(d){var c=$("#js-image-fs");if(c.data("fullscreen")){this.closeFullscreen();$.cookie("image-viewer-fullscreen",false)}else{this.openFullscreen();$.cookie("image-viewer-fullscreen",true)}return false},openFullscreen:function(){var c=$("#js-image-fs");if(c.data("fullscreen")){return}c.data("cachedSideColWidth",this.els.$sideColumn.width());c.data("cachedMainColWidth",this.els.$imagePane.width());this.paneWidth=Phoenix.jQuery.getWindow().width();this.els.$sideColumn.width("0");this.els.$imagePane.width(this.paneWidth);this.els.$imageClose.css({right:40});this.centerFilmstripTab();this.imageView.centerImage();this.isFullscreen=true;c.data("fullscreen",true)},closeFullscreen:function(){var c=$("#js-image-fs");if(!c.data("fullscreen")){return}var d=c.data("cachedSideColWidth");this.els.$sideColumn.width(d);this.paneWidth=this.windowWidth-d;this.els.$imagePane.css({width:this.paneWidth,height:this.paneHeight});this.els.$imageClose.css({right:d+40});this.centerFilmstripTab();this.imageView.centerImage();c.data("fullscreen",false);this.isFullscreen=false},isCommandsTipOpen:function(){var c=this.els.$commandsTip;if(c.hasClass("image-commands-tip-fade-out")){return"fadedOut"}else{if(c.hasClass("image-commands-tip-hide")){return false}else{return true}}},shouldShowCommandsTip:function(){if(!$.cookie(this.commandsTipCookieKey)){$.cookie(this.commandsTipCookieKey,"1",{expires:30,path:"/"});return true}else{if(this.isCommandsTipOpen()){this.toggleCommandsTip("hide")}return false}},toggleCommandsTip:function(d){var c=this;switch(d){case"show":if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}if(this.isCommandsTipOpen()!==true){this.els.$commandsTip.removeClass("image-commands-tip-fade-out image-commands-tip-hide")}this.commandsTipTimeout=window.setTimeout(function(){c.toggleCommandsTip("fadeOut")},this.commandsTipFadeOutDelay);break;case"fadeOut":if(this.isCommandsTipOpen()===true){this.els.$commandsTip.addClass("image-commands-tip-fade-out");this.commandsTipTimeout=window.setTimeout(function(){c.toggleCommandsTip("hide")},this.commandsTipHideDelay)}break;default:if(this.isCommandsTipOpen()!==false){if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}this.els.$commandsTip.addClass("image-commands-tip-hide").removeClass("image-commands-tip-fade-out")}}}}))}(Phoenix.ImageViewer||{}));
(function(a){a.Views.TitleBar=Backbone.View.extend({el:$("#js-image-title"),initialize:function(){this.render()},render:function(){this.$el.html(this.model.get("caption"));return this}})}(Phoenix.ImageViewer||{}));
(function(a){a.Views.InfoBar=Backbone.View.extend({el:$("#imageInfo"),template:_.template($("#imageInfoBarTemplate").html()),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}})}(Phoenix.ImageViewer||{}));
(function(a){a.Views.ImageView=Backbone.View.extend({el:$("#imageSource"),imagePane:$("#js-image-pane"),loader:null,initialize:function(){this.paneHeight=a.App.paneHeight;this.paneWidth=a.App.paneWidth;this.oldPaneHeight=this.paneHeight;this.oldPaneWidth=this.paneWidth;this.imageHeight=this.model.get("height");this.imageWidth=this.model.get("width");this.realImageHeight=this.model.get("height");this.realImageWidth=this.model.get("width");this.imageHeight=null;this.imageWidth=null;if(this.imageHeight===null){var d=new Image();d.src=this.model.get("original");var c=this;var b=this;d.onload=function(){c.imageHeight=this.height;c.imageWidth=this.width;c.realImageHeight=this.height;c.realImageWidth=this.width;b.model.set("height",this.height);b.model.set("width",this.width);c.resetImageSize();b.centerImage()}}this.model.on("change:height",function(){this.imageHeight=this.model.get("height")},this);this.model.on("change:width",function(){this.imageWidth=this.model.get("width")},this);this.clearImage();this.$el.fadeOut("fast",$.proxy(this.render,this))},checkDimensions:function(){if(this.realImageWidth<=a.App.paneWidth&&this.realImageHeight<=a.App.paneHeight){this.resetImageSize();return}if(a.App.paneWidth>0&&this.imageWidth===0){this.imageWidth=1}if(a.App.paneHeight>0&&this.imageHeight===0){this.imageHeight=1}if(this.oldPaneWidth!=a.App.paneWidth||this.imageWidth>a.App.paneWidth){this.adjustWidth()}if(this.oldPaneHeight!=a.App.paneHeight||this.imageHeight>a.App.paneHeight){this.adjustHeight()}this.oldPaneWidth=a.App.paneWidth;this.oldPaneHeight=a.App.paneHeight},adjustWidth:function(){this.model.set({width:a.App.paneWidth,height:Math.round((this.realImageHeight/this.realImageWidth)*a.App.paneWidth)})},adjustHeight:function(){this.model.set({width:Math.round((this.imageWidth/this.imageHeight)*a.App.paneHeight),height:a.App.paneHeight})},resetImageSize:function(){this.model.set({width:this.realImageWidth,height:this.realImageHeight})},resetWidth:function(){this.model.set({width:this.realImageWidth})},resetHeight:function(){this.model.set({height:this.realImageHeight})},render:function(){Phoenix.getDocument().trigger("pre_page_event",["image_view"]);var b=this,d=this.$el,c=this.model.get("original");this.imagePane.addClass("loading");this.loader=$("<img />").on("load",function(){d.css({height:b.imageHeight,width:b.imageWidth}).attr("src",c);b.centerImage().imagePane.removeClass("loading");d.fadeIn("fast");var f=b.model.get("comments");if(!f){var e=b.model.get("getCommentsUrl");$.ajax({url:e,async:false,data:{guid:b.model.get("id")},success:function(g){if(g.success){var h=g.data;b.model.set("comments",h);a.App.comments=new a.Views.Comments({collection:new a.Collections.Comments(h)})}}})}}).on("error",function(){Phoenix.Ui.showErrorMessage("Error loading image. Please try another.")}).attr("src",c);Phoenix.getDocument().trigger("on_page_event",["image_view"]);$(window).trigger("resize");return this},centerImage:function(b){this.checkDimensions();this.$el.css({width:this.imageWidth,height:this.imageHeight,top:(this.imageHeight>=a.App.paneHeight)?0:(a.App.paneHeight-this.imageHeight)/2,left:(this.imageWidth>=a.App.paneWidth)?0:(a.App.paneWidth-this.imageWidth)/2});if(b){b.call(this)}return this},clearImage:function(){this.$el.attr("src","");Phoenix.getDocument().trigger("post_page_event",["image_view"])}})}(Phoenix.ImageViewer||{}));
(function(a){a.Views.FilmstripItem=Backbone.View.extend({el:$("#js-image-strip"),template:_.template($("#imageFilmstripTemplate").html()),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.template(this.model.toJSON())}})}(Phoenix.ImageViewer||{}));
(function(a){a.Views.Filmstrip=Backbone.View.extend(_.extend({},a.Views.Mixins,{el:$("#js-image-strip"),loadMore:$("#js-image-strip-load-more"),highlightedClass:"imgboxart",scrollThreshold:100,throttledLazyLoad:null,built:false,events:{"click #js-image-strip-load-more":"loadMoreImages","click a":"showImage",scroll:"checkScroll"},initialize:function(){this.collection.on("reset",function(b){this.built=false;this.collection.models=b.models;this.clearImages()},this).on("add",function(b){console.log("add");this.addImage(b)},this);this.$el.closest(".image-strip").addClass("imagestripActive");this.isLoading=false;this.throttledLazyLoad=_.throttle(this.loadVisibleImages,100);this.$el.contents().filter(function(){return this.nodeType===3}).remove()},render:function(c,b){if(this.built){this.scrollToIndex(b);this.loadVisibleImages();this.highlight(b);return false}c=c||this.collection.models;_.each(c,function(d){this.addImage(d)},this);if(b){this.scrollToIndex(b)}this.loadVisibleImages();if(b){this.highlight(b)}this.built=true;return this},scrollToIndex:function(c){var b=this.$el.find("li:eq("+c+")");var d=b.position().top+this.$el.scrollTop();this.$el.scrollTop(d)},showImage:function(g){g.preventDefault();g.stopPropagation();var h=a.App,f=null;var d=null;if(g.which===Phoenix.Core.keycodes.enterKey){d=this.$el.find("li ."+this.highlightedClass).parents("li").first();if(d.attr("id")==="js-image-strip-load-more"){this.loadMoreImages();return}f=d.find("a").attr("data-ref-id")}else{d=$(g.target);f=d.attr("data-ref-id");d=d.parent()}var c=this.$el.find("li").length;var b=this.$el.find("li").index(d[0]);if(b+5>c){h.filmstrip.loadMoreImages()}h.setUrlHash(f).toggleFilmStrip()},clearImages:function(){this.$el.children().remove()},addImage:function(c){var b=$(new a.Views.FilmstripItem({model:c}).render());b.contents().filter(function(){return this.nodeType===3}).remove();this.$el.append(b);this.loadMore.remove();this.$el.append(this.loadMore)},highlight:function(b){this.$el.find("li a."+this.highlightedClass).removeClass(this.highlightedClass).end().find("li:eq("+b+") a").addClass(this.highlightedClass)},moveHighlight:function(e){var l=this.$el.find("li"),k=this,h=l.filter(function(){return $(this).find("a."+k.highlightedClass).length>0}),g=h.index(),c=function(o){h.find("a").removeClass();var q=l.eq(o);q.find("a").addClass(k.highlightedClass);if(o+5>l.length){k.loadMoreImages()}var n=k.$el.scrollTop();var s=q.position().top;var p=s+n+q.outerHeight();var m=n+k.$el.outerHeight();if(p>m){var r=p-m+20;k.$el.animate({scrollTop:n+r},1000)}else{if(s<0){k.$el.animate({scrollTop:n+s-20},1000)}}};var d=l.first().position().left;var i=this.$el.outerWidth();var f=l.first().outerWidth(true);var b=Math.floor((i-(2*d))/f);if(e==="right"){if(g===l.length-2){return false}c(g+1)}else{if(e==="up"){if(g===0){return false}var j=g-b;if(j<0){j=0}c(j)}else{if(e==="down"){if(g===l.length-2){return false}var j=g+b;if(j>l.length-2){j=l.length-2}c(j)}else{if(e==="left"){if(g===0){return false}c(g-1)}}}}},checkScroll:function(){var b=this;if(this.el.scrollTop+this.el.clientHeight+this.scrollThreshold>this.el.scrollHeight){this.loadResults(a.App,{success:b.loadVisibleImages})}this.throttledLazyLoad()},loadMoreImages:function(){this.loadResults(a.App,{success:this.loadVisibleImages});this.throttledLazyLoad()},loadVisibleImages:function(){a.App.stripHeight=a.App.els.$viewer.find("#js-image-strip").height();if(this.loadingVisible){return false}this.loadingVisible=true;this.$el.find("img[data-img-src]").each(function(){var c=$(this),b=Math.round(c.closest("li").position().top);if(b>=0&&b<=a.App.stripHeight&&c.data("imgSrc")){$("<img />").on("load",function(){c.attr("src",c.data("imgSrc")).addClass("loaded").removeAttr("data-img-src")}).attr("src",c.data("imgSrc"))}});this.loadingVisible=false}}))}(Phoenix.ImageViewer||{}));
(function(a){a.Views.Comments=Backbone.View.extend({el:$("#imageComments"),template:_.template($("#imageCommentsTemplate").html()),initialize:function(){this.$el.empty();this.render()},render:function(){_.each(this.collection.models,function(b){this.add(b.toJSON())},this);return this},add:function(b){if(!b){Phoenix.Ui.showErrorMessage("Error posting comment, please try again later.");return false}this.$el.append(this.template(b));return true}})}(Phoenix.ImageViewer||{}));
(function(a){a.Views.CommentPoster=Backbone.View.extend({el:$("#imageCommentPoster"),posting:false,initialize:function(){var b=this;this.$el.find("#postComment").on("click",function(c){c.preventDefault();c.stopPropagation();if(b.posting){return}var d=b.$el.find("#imageComment").val();b.posting=true;$.ajax({type:"POST",url:a.App.commentUrl,data:{guid:a.App.activeGuid,comment:d},beforeSend:function(){},complete:function(){b.posting=false},success:function(f){var e=a.App.comments.add(f.data);if(!e){return}Phoenix.Ui.showSuccessMessage("Comment posted.");b.$el.find("#imageComment").val("");b.hideComments()},error:function(e,g,f){Phoenix.Ui.showSuccessMessage("Error posting comment.")}})})},hideComments:function(){this.$el.parent().addClass("hide")},showComments:function(){this.$el.parent().removeClass("hide")}})}(Phoenix.ImageViewer||{}));
(function(a){a.Routers=a.Routers||{};a.Routers.ImageViewer=Backbone.Router.extend({routes:{"images/:id/":"loadImage","images/:id":"loadImage","*notFound":"closeViewer"},initialize:function(){a.App=new a.Views.Viewer({collection:new a.Collections.Images()})},loadImage:function(c){a.App.loadImage(c);var b=$('meta[itemprop="deviceType"]').attr("content");if(b==="phone"){return}a.App.commentPoster.showComments();if($.cookie("image-viewer-fullscreen")==="true"){a.App.openFullscreen()}else{a.App.closeFullscreen()}},closeViewer:function(b){a.App.closeViewer()}})}(Phoenix.ImageViewer||{}));$(function(a){a.Routers.AppRouter=new a.Routers.ImageViewer();var b=false;Phoenix.jQuery.getWindow().on("collectionLoaded",function(){var c=$('meta[itemprop="deviceType"]').attr("content");if(!b&&c!=="phone"){if(!window.history.pushState){var d=location.pathname;if(d.indexOf("/images/")===0||d.indexOf("images")===0){if(d.indexOf("/")===0){d=d.substr(1)}location.hash=d}Backbone.history.start({pushState:false,root:location.host+location.pathname})}else{Backbone.history.start({pushState:true})}b=true}})}(Phoenix.ImageViewer||{}));